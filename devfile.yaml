apiVersion: 1.0.0
metadata:
  generateName: wksp-cloud-native
projects:
  - name: workshop
    source:
      location: 'https://github.com/mcouliba/cloud-native-workshop.git'
      type: git
      branch: master
components:
  - id: redhat/java/latest
    type: chePlugin
    alias: java
  - id: redhat/workshop-tools/latest
    type: chePlugin
    alias: workshop-tools
commands:
  - name: 'OpenShift - Login'
    actions:
      - type: exec
        command: >-
          oc login --server=$(oc whoami --show-server) -u
          ${CHE_WORKSPACE_NAMESPACE}  -p 'openshift' --insecure-skip-tls-verify
          &&  oc project cn-project${CHE_WORKSPACE_NAMESPACE#user}
        component: workshop-tools
  - name: 'Inventory - Compile (Dev Mode)'
    actions:
      - workdir: /projects/workshop/labs/inventory-quarkus
        type: exec
        command: 'mvn compile quarkus:dev'
        component: workshop-tools
  - name: 'Inventory - Deploy on OpenShift'
    actions:
      - workdir: /projects/workshop/labs/inventory-quarkus
        type: exec
        command: >-
          mvn clean package -DskipTests && 
          oc new-build --name=inventory java --binary=true && oc start-build
          inventory --from-file=target/inventory-quarkus-1.0.0-SNAPSHOT-runner.jar
          --follow && oc new-app inventory &&  oc expose svc inventory
        component: workshop-tools
  - name: 'Inventory - Build on OpenShift'
    actions:
      - workdir: /projects/workshop/labs/inventory-quarkus
        type: exec
        command: >-
          mvn clean package -DskipTests &&
          oc start-build inventory
          --from-file=target/inventory-quarkus-1.0.0-SNAPSHOT-runner.jar --follow
        component: workshop-tools
  - name: 'Catalog - Build'
    actions:
      - workdir: /projects/workshop/labs/catalog-spring-boot
        type: exec
        command: mvn clean package -DskipTests
        component: workshop-tools
  - name: 'Catalog - Run'
    actions:
      - workdir: /projects/workshop/labs/catalog-spring-boot
        type: exec
        command: mvn spring-boot:run
        component: workshop-tools
  - name: 'Catalog - Deploy on OpenShift'
    actions:
      - workdir: /projects/workshop/labs/catalog-spring-boot
        type: exec
        command: mvn clean fabric8:deploy
        component: workshop-tools
  - name: 'Gateway - Build'
    actions:
      - workdir: /projects/workshop/labs/gateway-vertx
        type: exec
        command: 'mvn clean package -DskipTests'
        component: workshop-tools
  - name: 'Gateway - Deploy on OpenShift'
    actions:
      - workdir: /projects/workshop/labs/gateway-vertx
        type: exec
        command: mvn clean fabric8:deploy
        component: workshop-tools