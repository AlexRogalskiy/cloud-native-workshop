apiVersion: 1.0.0
metadata:
  generateName: wksp-cloud-native
projects:
  - name: workshop
    source:
      location: 'https://github.com/mcouliba/cloud-native-workshop.git'
      type: git
      branch: master
components:
  - id: redhat/java/latest
    type: chePlugin
    alias: java
  - id: redhat/workshop-tools/latest
    type: chePlugin
    alias: workshop-tools
commands:
  - name: 'OpenShift: Login'
    actions:
      - type: exec
        command: >-
          oc login --server=$(oc whoami --show-server) -u
          ${CHE_WORKSPACE_NAMESPACE}  -p 'openshift' --insecure-skip-tls-verify
          &&  oc project cn-project${CHE_WORKSPACE_NAMESPACE#user}
        component: workshop-tools
  - name: 'Quarkus: Compile Inventory Service (Dev Mode)'
    actions:
      - workdir: /projects/inventory
        type: exec
        command: 'mvn compile quarkus:dev'
        component: workshop-tools
  - name: 'Inventory: Local Build'
    actions:
      - workdir: /projects/inventory
        type: exec
        command: mvn clean package -DskipTests
        component: workshop-tools
  - name: 'Inventory: Initialize on OpenShift'
    actions:
      - workdir: /projects/inventory
        type: exec
        command: >-
          mvn clean package -DskipTests && 
          oc new-build --name=inventory java --binary=true && oc start-build
          inventory --from-file=target/inventory-1.0.0-SNAPSHOT-runner.jar
          --follow && oc new-app inventory &&  oc expose svc inventory
        component: workshop-tools
  - name: 'Inventory: Start Build on OpenShift'
    actions:
      - workdir: /projects/inventory
        type: exec
        command: >-
          mvn clean package -DskipTests &&
          oc start-build inventory
          --from-file=target/inventory-1.0.0-SNAPSHOT-runner.jar --follow
        component: workshop-tools
