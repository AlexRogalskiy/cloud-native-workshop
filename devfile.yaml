metadata:
  name: wksp-cloud-native-demo
attributes:
  extensions.ignoreRecommendations: 'true'
projects:
  - name: workshop
    source:
      location: 'https://github.com/mcouliba/cloud-native-workshop.git'
      type: github
      branch: 'demo-mode'
components:
  - type: chePlugin
    id: redhat/java11/latest
    preferences:
      java.server.launchMode: Standard
      java.autobuild.enabled: false
  - type: dockerimage
    image: 'quay.io/mcouliba/workshop-tools:5.0'
    alias: workshop-tools
    memoryLimit: "3072M"
    mountSources: true
    env:
      - name: MAVEN_OPTS
        value: '-Xmx2048m -Duser.home=/home/developer'
      - name: MAVEN_MIRROR_URL
        value: http://nexus.opentlc-shared.svc:8081/repository/maven-all-public
    endpoints:
       - name: 8080-port
         port: 8080
         attributes:
           protocol: http
           public: 'true'
       - name: 9000-port
         port: 9000
         attributes:
           protocol: http
           public: 'true'
    volumes:
      - name: kubefolder
        containerPath: /home/developer/.kube
apiVersion: 1.0.0
commands:
  - name: '0. OpenShift - Cleanup'
    actions:
      - command: >-
           git checkout .; git clean -fd; git clean -f; oc delete project my-project${CHE_WORKSPACE_NAMESPACE#user}; oc delete deployment,deploymentconfig,buildconfig,imagestream,route,secret,configmap,pvc,service,pipeline,pipelinerun --all --namespace cn-project${CHE_WORKSPACE_NAMESPACE#user}
        type: exec
        component: workshop-tools
        workdir: /projects/workshop
  - name: '0. OpenShift - Demo Preparation'
    actions:
      - command: >-
           odo login $(oc whoami --show-server) --username=${CHE_WORKSPACE_NAMESPACE} --password=openshift --insecure-skip-tls-verify;/projects/workshop/.tasks/inner_loop_deploy_coolstore.sh my-project${CHE_WORKSPACE_NAMESPACE#user};/projects/workshop/.tasks/outer_loop_deploy_coolstore.sh ${CHE_WORKSPACE_NAMESPACE#user};oc delete deployment,deploymentconfig,buildconfig,imagestream,route,secret,configmap,service,pvc --all --namespace my-project${CHE_WORKSPACE_NAMESPACE#user};oc delete deployment,deploymentconfig,buildconfig,route,service,pipeline,pipelinerun --all --namespace cn-project${CHE_WORKSPACE_NAMESPACE#user};git checkout .; git clean -fd; git clean -f;oc project my-project${CHE_WORKSPACE_NAMESPACE#user}
        type: exec
        component: workshop-tools
        workdir: /projects/workshop
  - name: 'i1. OpenShift - Login'
    actions:
      - command: >-
          odo login $(oc whoami --show-server) --username=${CHE_WORKSPACE_NAMESPACE} --password=openshift --insecure-skip-tls-verify
        type: exec
        component: workshop-tools
        workdir: /projects/workshop
  - name: 'i2. Inventory - Code'
    actions:
      - command: >-
           ./solve.sh
        type: exec
        component: workshop-tools
        workdir: /projects/workshop/.tasks/solutions/inventory-quarkus
  - name: 'i3. Inventory - Build'
    actions:
      - command: >-
          mvn clean package -DskipTests
        type: exec
        component: workshop-tools
        workdir: /projects/workshop/labs/inventory-quarkus
  - name: 'i4. Catalog & Gateway - Code & Deploy'
    actions:
      - command: >-
           cd catalog-spring-boot;./solve_deploy.sh my-project${CHE_WORKSPACE_NAMESPACE#user}; cd ..; cd gateway-vertx;./solve_deploy.sh my-project${CHE_WORKSPACE_NAMESPACE#user}; cd ..; 
        type: exec
        component: workshop-tools
        workdir: /projects/workshop/.tasks/solutions
  - name: 'i5. Probes & Config - Deploy'
    actions:
      - command: >-
           cd health-probes; ./deploy.sh my-project${CHE_WORKSPACE_NAMESPACE#user}; cd ..; cd app-config; ./deploy.sh my-project${CHE_WORKSPACE_NAMESPACE#user}; cd ..
        type: exec
        component: workshop-tools
        workdir: /projects/workshop/.tasks/solutions
  - name: 'i+. Inventory - Compile (Dev Mode)'
    actions:
      - command: >-
          [[ ! -z "$(ps aux | grep -v grep | grep "compile quarkus:dev" | awk 'print $2')" ]] &&  echo '!! Application already running in Dev Mode !!' ||  mvn compile quarkus:dev -Ddebug=false
        type: exec
        component: workshop-tools
        workdir: /projects/workshop/labs/inventory-quarkus
  - name: 'i+. Inventory - Create Component'
    actions:
      - command: >-
          odo component create java:11 inventory --app coolstore --binary target/inventory-quarkus-1.0.0-SNAPSHOT-runner.jar --s2i --project my-project${CHE_WORKSPACE_NAMESPACE#user}
        type: exec
        component: workshop-tools
        workdir: /projects/workshop/labs/inventory-quarkus
  - name: 'i+. Inventory - Push'
    actions:
      - command: >-
          odo push
        type: exec
        component: workshop-tools
        workdir: /projects/workshop/labs/inventory-quarkus
  - name: 'i+. Inventory - Expose'
    actions:
      - command: >-
          odo url create inventory --port 8080
        type: exec
        component: workshop-tools
        workdir: /projects/workshop/labs/inventory-quarkus
  - name: 'o1. Pipeline - Deploy Coolstore'
    actions:
      - command: >-
          oc project cn-project${CHE_WORKSPACE_NAMESPACE#user} && ./pipeline_deploy_coolstore.sh cn-project${CHE_WORKSPACE_NAMESPACE#user}
        type: exec
        component: workshop-tools
        workdir: /projects/workshop/.tasks
  - name: 'o2. Service Mesh - Deploy Catalog and Gateway'
    actions:
      - command: >-
          oc patch dc/catalog-coolstore --patch '"spec": "template": "metadata": "annotations": "sidecar.istio.io/inject": "true"' -n cn-project${CHE_WORKSPACE_NAMESPACE#user} && oc rollout latest dc/catalog-coolstore -n cn-project${CHE_WORKSPACE_NAMESPACE#user} && oc patch dc/gateway-coolstore --patch '"spec": "template": "metadata": "annotations": "sidecar.istio.io/inject": "true"' -n cn-project${CHE_WORKSPACE_NAMESPACE#user} && oc rollout latest dc/gateway-coolstore -n cn-project${CHE_WORKSPACE_NAMESPACE#user}'
        type: exec
        component: workshop-tools
        workdir: /projects/workshop
